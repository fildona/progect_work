<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Richieste di Finanziamento</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
    <h2>Richieste di Finanziamento</h2>
    <form id="filterForm" class="row g-3 mb-3">
        <!-- Esempio: Eta -->
        <div class="col-md-2">
            <label>Età</label>
            <input type="number" class="form-control" name="Eta_min" placeholder="Min">
            <input type="number" class="form-control mt-1" name="Eta_max" placeholder="Max">
        </div>
        <div class="col-md-2">
            <label>Sesso</label>
            <select class="form-select" name="Sesso">
                <option value="">Tutti</option>
                <option value="M">M</option>
                <option value="F">F</option>
            </select>
        </div>
        <div class="col-md-2">
            <label>Titolo Studio</label>
            <select class="form-select" name="TitoloStudio">
                <option value="">Tutti</option>
                <option value="Licenza media">Licenza media</option>
                <option value="Diploma">Diploma</option>
                <option value="Laurea">Laurea</option>
                <option value="Dottorato di ricerca">Dottorato di ricerca</option>
            </select>
        </div>
        <div class="col-md-2">
            <label>Reddito Lordo</label>
            <input type="number" class="form-control" name="RedditoLordoUltimoAnno_min" placeholder="Min">
            <input type="number" class="form-control mt-1" name="RedditoLordoUltimoAnno_max" placeholder="Max">
        </div>
        <div class="col-md-2">
            <label>Anni Esperienza</label>
            <input type="number" class="form-control" name="AnniEsperienzaLavorativa_min" placeholder="Min">
            <input type="number" class="form-control mt-1" name="AnniEsperienzaLavorativa_max" placeholder="Max">
        </div>
        <div class="col-md-2">
            <label>Immobile</label>
            <select class="form-select" name="InformazioniImmobile">
                <option value="">Tutti</option>
                <option value="Affitto">Affitto</option>
                <option value="Proprietà">Proprietà</option>
                <option value="ProprietàMutuoDaEstinguere">ProprietàMutuoDaEstinguere</option>
                <option value="ProprietàMutuoEstinto">ProprietàMutuoEstinto</option>
            </select>
        </div>
        <!-- Altri filtri come sopra... -->
        <div class="col-12">
            <button type="submit" class="btn btn-primary">Cerca</button>
            <button type="button" class="btn btn-secondary" id="resetBtn">Reset</button>
            <button type="button" class="btn btn-success" id="exportCsv">Esporta CSV</button>
            <button type="button" class="btn btn-success" id="exportExcel">Esporta Excel</button>
            <button type="button" class="btn btn-success" id="exportJson">Esporta JSON</button>
        </div>
    </form>
    <div class="table-responsive">
        <table class="table table-bordered" id="resultsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Età</th>
                    <th>Sesso</th>
                    <th>Titolo Studio</th>
                    <th>Reddito Lordo</th>
                    <th>Anni Esperienza</th>
                    <th>Immobile</th>
                    <th>Importo Richiesto</th>
                    <th>Scopo</th>
                    <th>Tasso Interesse</th>
                    <th>Importo/Reditto</th>
                    <th>Durata Storia Creditizia</th>
                    <th>Affidabilità Creditizia</th>
                    <th>Inadempienze Precedenti</th>
                    <th>Probabilità Approvazione</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<script>
function buildQueryString(form) {
    const params = [];
    for (const el of form.elements) {
        if (el.name && el.value) params.push(encodeURIComponent(el.name) + "=" + encodeURIComponent(el.value));
    }
    return params.length ? "?" + params.join("&") : "";
}

function fetchResults() {
    const form = document.getElementById('filterForm');
    const qs = buildQueryString(form);
    fetch('/api/richieste' + qs)
        .then(r => r.json())
        .then(data => {
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = "";
            data.forEach(row => {
                tbody.innerHTML += `
                    <tr>
                        <td>${row.RichiestaFinanziamentoID}</td>
                        <td>${row.Eta}</td>
                        <td>${row.Sesso}</td>
                        <td>${row.TitoloStudio}</td>
                        <td>${row.RedditoLordoUltimoAnno}</td>
                        <td>${row.AnniEsperienzaLavorativa}</td>
                        <td>${row.InformazioniImmobile}</td>
                        <td>${row.ImportoRichiesto}</td>
                        <td>${row.ScopoFinanziamento}</td>
                        <td>${row.TassoInteresseFinanziamento}</td>
                        <td>${row.ImportoRichiestoDivisoReddito}</td>
                        <td>${row.DurataDellaStoriaCreditiziaInAnni}</td>
                        <td>${row['AffidabilitàCreditizia']}</td>
                        <td>${row.InadempienzeFinanziamentiPrecedenti}</td>
                        <td>${(row.ProbabilitaFinanziamentoApprovato*100).toFixed(2)}%</td>
                    </tr>
                `;
            });
        });
}

document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    fetchResults();
});
document.getElementById('resetBtn').addEventListener('click', function() {
    document.getElementById('filterForm').reset();
    fetchResults();
});
document.getElementById('exportCsv').addEventListener('click', function() {
    const qs = buildQueryString(document.getElementById('filterForm'));
    window.location = '/api/richieste/export?format=csv' + qs.replace('?', '&');
});
document.getElementById('exportExcel').addEventListener('click', function() {
    const qs = buildQueryString(document.getElementById('filterForm'));
    window.location = '/api/richieste/export?format=excel' + qs.replace('?', '&');
});
document.getElementById('exportJson').addEventListener('click', function() {
    const qs = buildQueryString(document.getElementById('filterForm'));
    window.location = '/api/richieste/export?format=json' + qs.replace('?', '&');
});

window.onload = fetchResults;
</script>
</body>
</html>